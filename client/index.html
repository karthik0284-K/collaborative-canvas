<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Collaborative Canvas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:"Poppins",sans-serif; background:linear-gradient(135deg,#0f172a,#1e3a8a); color:#f1f5f9; overflow:hidden; }

    /* Homepage */
    #homepage { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; }
    .home-box {
      background:rgba(255,255,255,0.1); padding:40px; border-radius:16px;
      backdrop-filter:blur(10px); box-shadow:0 4px 30px rgba(0,0,0,0.3); width:320px;
      text-align:center; transition:all 0.3s ease;
    }
    .home-box:hover { transform:scale(1.02); }
    .home-box input { width:100%; padding:8px; margin:10px 0; border:none; border-radius:8px; }
    button { cursor:pointer; border:none; border-radius:8px; padding:10px 16px; font-size:15px; transition:all 0.3s; }
    .btn-primary { background:#2563eb; color:white; } .btn-primary:hover{background:#1d4ed8;}
    .btn-secondary { background:transparent; border:1px solid rgba(255,255,255,0.4); color:white; }

    /* Canvas Page */
    #canvasPage { display:none; height:100%; position:relative; }
    #board { width:100%; height:100%; display:block; background:#fff; cursor:crosshair; }

    #toolbar {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.95); padding:10px 18px; border-radius:14px;
      display:flex; gap:10px; align-items:center; box-shadow:0 4px 25px rgba(0,0,0,0.3); z-index:10;
    }
    #toolbar select { border:none; background:#e2e8f0; border-radius:8px; padding:6px; }

    .cursor {
      position:absolute; pointer-events:none; transform:translate(-50%,-50%);
      border-radius:50%; width:12px; height:12px; z-index:20;
    }
    .cursor .nameTag {
      position:absolute; top:-20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.6); color:white; font-size:10px; padding:2px 4px; border-radius:4px; display:none;
    }
    .cursor:hover .nameTag { display:block; }
  </style>
</head>
<body>
  <div id="homepage">
    <div class="home-box">
      <h1>üé® Collaborative Canvas</h1>
      <p>Draw alone or create a shared room with friends.</p>
      <button id="soloBtn" class="btn-primary" style="width:100%">Draw Alone</button>
      <hr style="opacity:0.3;margin:20px 0;">
      <input id="roomInput" placeholder="Enter room name..." />
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="joinBtn" class="btn-primary">Join Room</button>
        <button id="createBtn" class="btn-secondary">Create Room</button>
      </div>
    </div>
  </div>

  <div id="canvasPage">
    <div id="toolbar">
      <label>üé® <input type="color" id="color" value="#000000" /></label>
      <label>üñãÔ∏è <input type="range" id="width" min="1" max="20" value="4" /></label>
      <select id="userList"><option>üë• Users</option></select>
      <button id="brushBtn">Brush</button>
      <button id="eraserBtn">Eraser</button>
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
      <button id="clearBtn">Clear</button>
      <button id="backBtn" style="background:#f87171;color:white;">Back</button>
    </div>
    <canvas id="board"></canvas>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module">
    import { Canvas } from "./canvas.js";

    const homepage = document.getElementById("homepage");
    const canvasPage = document.getElementById("canvasPage");
    const userList = document.getElementById("userList");
    let socket, canvasApp;

    async function checkRoomExists(room) {
      const res = await fetch(`/check-room?room=${room}`);
      const data = await res.json();
      return data.exists;
    }

    async function createRoom(room) {
      await fetch(`/create-room?room=${room}`);
    }

    async function openCanvas(room, local=false) {
      homepage.style.display = "none";
      canvasPage.style.display = "block";

      socket = local ? null : io({ query: { room } });
      canvasApp = new Canvas(socket, room);

      if (socket) {
        socket.on("user:list", (users) => {
          userList.innerHTML = `<option>üë• Users (${users.length})</option>`;
          users.forEach(u => {
            const opt = document.createElement("option");
            opt.textContent = u.name;
            opt.style.color = u.color;
            userList.appendChild(opt);
          });
        });
      }

      document.getElementById("color").oninput = (e)=>canvasApp.color=e.target.value;
      document.getElementById("width").oninput = (e)=>canvasApp.lineWidth=parseInt(e.target.value);
      document.getElementById("brushBtn").onclick = ()=>canvasApp.tool="brush";
      document.getElementById("eraserBtn").onclick = ()=>canvasApp.tool="eraser";
      document.getElementById("undoBtn").onclick = ()=>canvasApp.undo();
      document.getElementById("redoBtn").onclick = ()=>canvasApp.redo();
      document.getElementById("clearBtn").onclick = ()=>canvasApp.clear();
      document.getElementById("backBtn").onclick = ()=>{
        if(confirm("Leave room?")) {
          if(socket) socket.disconnect();
          canvasPage.style.display="none"; homepage.style.display="flex";
        }
      };
    }

    document.getElementById("soloBtn").onclick = ()=>openCanvas(null,true);

    // ‚úÖ Fixed Create Room button logic
    document.getElementById("createBtn").onclick = async ()=>{
      let room = document.getElementById("roomInput").value.trim();
      if (!room) {
        room = "room-" + Math.random().toString(36).substring(2,8);
      }

      // Normalize to lowercase to avoid duplicates like 'Room1' vs 'room1'
      room = room.toLowerCase();

      const exists = await checkRoomExists(room);
      if (exists) {
        alert("‚ö†Ô∏è Room already exists! Try a different name.");
        return;
      }

      await createRoom(room);
      alert("‚úÖ Room created! Share this link:\n" + location.origin + "?room=" + room);
      openCanvas(room);
    };

    // ‚úÖ Join Room button logic (unchanged)
    document.getElementById("joinBtn").onclick = async ()=>{
      const room = document.getElementById("roomInput").value.trim().toLowerCase();
      if(!room) return alert("Enter room name");
      const exists = await checkRoomExists(room);
      if(!exists) return alert("üö´ Room not found! Ask your friend to create it first.");
      openCanvas(room);
    };

    // Auto-join via URL param
    const params = new URLSearchParams(window.location.search);
    const r = params.get("room");
    if (r) openCanvas(r);
  </script>
</body>
</html>
